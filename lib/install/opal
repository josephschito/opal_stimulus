#!/usr/bin/env ruby
require "bundler/setup"
require "listen"

build = -> {
  system("opal -E --output=app/assets/builds/opal.js -c app/opal/application.rb -Iapp/opal")
  puts "compiled opal.js"
}

update_opal_controllers_requires = -> {
  File.open('app/opal/controllers_requires.rb', 'w') do |f|
    f.puts "# This file is automatically generated by `bin/opal`.\n"
    f.puts "# If you want to update this file, please run: `bin/opal --update-requires`.\n\n"
    f.puts Dir["app/opal/controllers/**/*.rb"].sort.map { |file| "require '#{file.gsub("app/opal/", "").gsub(".rb", "")}'" }.join("\n")
  end

  puts "Updated app/opal/controllers_requires.rb file ðŸŽ‰"
}

if ARGV.include?("--update-requires")
  update_opal_controllers_requires.()
  exit
end

update_opal_controllers_requires.()
build.call

exit unless ARGV.include?("--watch")

listen = Listen.to("app/opal") do |modified, added, removed|
  if added.any? || removed.any?
    puts "ðŸ”„ Update opal controllers requires..."
    update_opal_controllers_requires.()
  end

  build.call
end

listen.start
Signal.trap('INT') { listen.stop }
sleep
